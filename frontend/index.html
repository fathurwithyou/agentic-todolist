<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Calendar Assistant - Google SSO</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            padding: 12px 24px;
            background-color: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .model-selection {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .model-selection h3 {
            margin: 0 0 15px 0;
            color: #555;
            font-size: 16px;
        }
        .model-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .model-row .form-group {
            margin-bottom: 0;
        }
        .api-key-section {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .api-key-section h4 {
            margin: 0 0 15px 0;
            color: #856404;
            font-size: 14px;
        }
        .toggle-api-key {
            background: none;
            border: none;
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin-bottom: 10px;
        }
        .api-key-inputs {
            display: none;
        }
        .api-key-inputs.show {
            display: block;
        }
        .login-container {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            margin: 50px auto;
        }
        .login-btn {
            background-color: #4285f4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }
        .login-btn:hover {
            background-color: #3367d6;
        }
        .user-info {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .user-details {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        .logout-btn {
            background-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        .hidden {
            display: none;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .time-fields {
            display: none;
        }
        .time-fields.show {
            display: flex;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        .preview-section {
            background-color: #f0f8f0;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        .preview-section.show {
            display: block;
        }
        .preview-event {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .preview-event h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .preview-actions {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .preview-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .calendar-item {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .calendar-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            font-weight: bold;
        }
        .calendar-info {
            flex: 1;
        }
        .calendar-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .calendar-details {
            font-size: 14px;
            color: #666;
        }
        .calendar-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }
        .badge-primary {
            background-color: #007bff;
            color: white;
        }
        .badge-owner {
            background-color: #28a745;
            color: white;
        }
        .badge-reader {
            background-color: #6c757d;
            color: white;
        }
        .refresh-btn {
            background-color: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background-color: #138496;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Calendar Assistant</h1>
        
        <!-- Login Section (shown when not authenticated) -->
        <div id="loginSection" class="login-container hidden">
            <h2>Welcome to AI Calendar Assistant</h2>
            <p>Please sign in with your Google account to continue</p>
            <button id="googleLoginBtn" class="login-btn">
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                    <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.04a4.8 4.8 0 0 1-7.18-2.53H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                    <path fill="#FBBC05" d="M4.5 10.49a4.8 4.8 0 0 1 0-3.07V5.35H1.83a8 8 0 0 0 0 7.28l2.67-2.14z"/>
                    <path fill="#EA4335" d="M8.98 3.58c1.32 0 2.5.45 3.44 1.35l2.54-2.54a8 8 0 0 0-5.98-2.39 8 8 0 0 0-7.15 4.42l2.67 2.14c.63-1.87 2.33-3.16 4.48-3.16z"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <!-- User Info (shown when authenticated) -->
        <div id="userSection" class="user-info hidden">
            <div class="user-details">
                <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                <div>
                    <strong id="userName"></strong><br>
                    <span id="userEmail" style="color: #666; font-size: 14px;"></span>
                </div>
            </div>
            <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>

        <!-- Main Application (shown when authenticated) -->
        <div id="mainApp" class="hidden">
            <div class="tabs">
                <button type="button" class="tab active" onclick="switchTab('timeline')">AI Timeline to Calendar</button>
                <button type="button" class="tab" onclick="switchTab('calendars')">My Calendars</button>
                <button type="button" class="tab" onclick="switchTab('apikeys')">API Keys</button>
            </div>

            <!-- Timeline Tab -->
            <div id="timelineTab" class="tab-content active">
                <div class="model-selection">
                    <h3>AI Model Selection</h3>
                    <div class="model-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="timelineProvider">Provider:</label>
                            <select id="timelineProvider" name="timelineProvider" required>
                                <option value="">Select Provider</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="timelineModel">Model:</label>
                            <select id="timelineModel" name="timelineModel">
                                <option value="">Select Model</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="targetCalendar">Target Calendar:</label>
                    <select id="targetCalendar" name="targetCalendar" required>
                        <option value="primary">Primary Calendar</option>
                    </select>
                    <small style="color: #666; font-size: 12px;">
                        Only calendars you can write to are shown. AI will understand calendar type from timeline text.
                    </small>
                </div>

            <form id="timelineForm">
                <div class="form-group">
                    <label for="timelineText">Timeline Text:</label>
                    <textarea id="timelineText" name="timelineText" required 
                        placeholder="Enter your timeline text here...
Example:
Timeline Gemastik

1 Juli–10 Agustus: Masa Submisi Proposal
11 Agustus–2 September: Penjurian
8 September: Pengumuman Finalis
27–30 Oktober: Babak Final

Invite: Fathur, Bimo, Guntara" 
                        style="height: 200px;"></textarea>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="flexible" name="flexible" checked>
                    <label for="flexible">Use flexible parsing (handles various text formats)</label>
                </div>

                <button type="submit" id="timelineSubmitBtn">Preview Timeline</button>
            </form>

            <!-- Preview Section -->
            <div id="previewSection" class="preview-section">
                <h3>📋 Preview Events</h3>
                <div id="previewInfo" class="preview-info"></div>
                <div id="previewEvents"></div>
                <div class="preview-actions">
                    <button type="button" id="confirmCreateBtn" class="button">✅ Confirm & Create Events</button>
                    <button type="button" id="cancelPreviewBtn" class="btn-secondary">❌ Cancel</button>
                </div>
            </div>

            <div id="timelineResult" class="result">
                <h3>Timeline Results:</h3>
                <div id="timelineResultContent"></div>
            </div>
        </div>


            <!-- Calendars Tab -->
            <div id="calendarsTab" class="tab-content">
                <h3>📅 My Google Calendars</h3>
                <p>View all your Google Calendar calendars including "Jadwal Lomba", "Jadwal Kuliah", and others.</p>
                
                <button id="refreshCalendarsBtn" class="refresh-btn">🔄 Refresh Calendar List</button>
                
                <div id="calendarsContainer">
                    <p>Click "Refresh Calendar List" to load your calendars...</p>
                </div>
            </div>

            <!-- API Keys Tab -->
            <div id="apikeysTab" class="tab-content">
                <h3>API Key Management</h3>
                <p>Save your AI provider API keys securely. These keys will be used to make requests to the AI models.</p>
                
                <div class="api-key-section">
                    <h4>📊 Your API Keys Status</h4>
                    <div id="apiKeyStatus">Loading...</div>
                </div>

                <div class="form-group">
                    <label for="apiProvider">Provider:</label>
                    <select id="apiProvider" required>
                        <option value="">Select Provider</option>
                        <option value="gemini">Google Gemini</option>
                        <option value="openai">OpenAI</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="apiKeyInput">API Key:</label>
                    <input type="password" id="apiKeyInput" placeholder="Enter your API key..." required>
                    <small style="color: #666; font-size: 12px;">
                        Your API key is stored securely and only used for your requests.
                    </small>
                </div>

                <button type="button" id="saveApiKeyBtn">💾 Save API Key</button>
                <button type="button" id="testApiKeyBtn" style="background-color: #007bff;">🔍 Test API Key</button>

                <div id="apiKeyResult" class="result">
                    <div id="apiKeyResultContent"></div>
                </div>

                <div class="api-key-section" style="margin-top: 30px;">
                    <h4>💡 How to get API Keys:</h4>
                    <ul style="text-align: left;">
                        <li><strong>Google Gemini:</strong> Visit <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a> to get your API key</li>
                        <li><strong>OpenAI:</strong> Visit <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a> to create an API key</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let providersData = {};
        let previewData = null; // Store preview data for confirmation
        let currentUser = null;
        let authToken = null;
        
        // Form elements
        const timelineForm = document.getElementById('timelineForm');
        const timelineResultDiv = document.getElementById('timelineResult');
        const timelineResultContent = document.getElementById('timelineResultContent');
        const timelineSubmitBtn = document.getElementById('timelineSubmitBtn');

        // Preview elements
        const previewSection = document.getElementById('previewSection');
        const previewInfo = document.getElementById('previewInfo');
        const previewEvents = document.getElementById('previewEvents');
        const confirmCreateBtn = document.getElementById('confirmCreateBtn');
        const cancelPreviewBtn = document.getElementById('cancelPreviewBtn');

        // Model selection elements
        const timelineProvider = document.getElementById('timelineProvider');
        const timelineModel = document.getElementById('timelineModel');
        const targetCalendar = document.getElementById('targetCalendar');
        
        // Authentication elements
        const loginSection = document.getElementById('loginSection');
        const userSection = document.getElementById('userSection');
        const mainApp = document.getElementById('mainApp');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');

        // API Key elements
        const apiProvider = document.getElementById('apiProvider');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const testApiKeyBtn = document.getElementById('testApiKeyBtn');
        const apiKeyResult = document.getElementById('apiKeyResult');
        const apiKeyResultContent = document.getElementById('apiKeyResultContent');
        const apiKeyStatus = document.getElementById('apiKeyStatus');

        // Calendar elements
        const refreshCalendarsBtn = document.getElementById('refreshCalendarsBtn');
        const calendarsContainer = document.getElementById('calendarsContainer');

        // Initialize page
        window.onload = async function() {
            // Check for token in URL (from OAuth callback)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                // Store token and verify it
                localStorage.setItem('auth_token', token);
                authToken = token;
                
                // Verify token with server
                try {
                    const response = await fetch(`http://localhost:8000/auth/verify?token=${token}`);
                    if (response.ok) {
                        const result = await response.json();
                        setAuthenticated(result.user, token);
                        
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // Load providers and calendars
                        await loadProviders();
                        await loadWritableCalendars();
                        return;
                    }
                } catch (error) {
                    console.error('Token verification failed:', error);
                    localStorage.removeItem('auth_token');
                }
            }
            
            // Check authentication status
            await checkAuthStatus();
            
            // Authentication check complete
            
            // Load available providers and models if authenticated
            if (currentUser) {
                await loadProviders();
                await loadWritableCalendars();
            }
        };

        // Authentication functions
        async function checkAuthStatus() {
            try {
                // Check if we have a stored JWT token
                const storedToken = localStorage.getItem('auth_token');
                if (storedToken) {
                    authToken = storedToken;
                    
                    // Verify token with server
                    const response = await fetch('http://localhost:8000/auth/profile', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const profile = await response.json();
                        setAuthenticated(profile, authToken);
                        return;
                    } else {
                        // Token is invalid, remove it
                        localStorage.removeItem('auth_token');
                        authToken = null;
                    }
                }
                
                // Not authenticated
                setNotAuthenticated();
            } catch (error) {
                console.error('Auth check failed:', error);
                setNotAuthenticated();
            }
        }

        function setAuthenticated(userProfile, token) {
            currentUser = userProfile;
            authToken = token;
            
            // Update UI
            userName.textContent = userProfile.name || userProfile.email;
            userEmail.textContent = userProfile.email;
            // Note: picture might not be available in the simplified response
            
            // Show authenticated sections
            loginSection.classList.add('hidden');
            userSection.classList.remove('hidden');
            mainApp.classList.remove('hidden');
        }

        function setNotAuthenticated() {
            currentUser = null;
            authToken = null;
            
            // Show login section
            loginSection.classList.remove('hidden');
            userSection.classList.add('hidden');
            mainApp.classList.add('hidden');
        }

        // Google SSO login
        googleLoginBtn.addEventListener('click', function() {
            // Simply redirect to the Google login endpoint
            window.location.href = 'http://localhost:8000/auth/google';
        });

        // Note: OAuth callback is now handled by the simplified fastapi-sso flow
        // The backend automatically redirects back with a JWT token in the URL

        // Logout
        logoutBtn.addEventListener('click', async function() {
            try {
                // Call logout endpoint
                if (authToken) {
                    await fetch('http://localhost:8000/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                }
            } catch (error) {
                console.error('Logout request failed:', error);
            }
            
            // Clear local storage and state
            localStorage.removeItem('auth_token');
            setNotAuthenticated();
        });

        // Note: Token-based authentication is handled in window.onload

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Hide all results when switching tabs
            timelineResultDiv.style.display = 'none';
            previewSection.classList.remove('show');
        }

        // Load available providers and models
        async function loadProviders() {
            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch('http://localhost:8000/api/v1/timeline/providers', {
                    headers: headers
                });
                
                if (response.ok) {
                    providersData = await response.json();
                    populateProviderDropdowns();
                } else {
                    console.warn('Could not load provider information');
                }
            } catch (error) {
                console.warn('Error loading providers:', error);
            }
        }

        // Populate provider dropdowns
        function populateProviderDropdowns() {
            // Clear existing options
            timelineProvider.innerHTML = '<option value="">Select Provider</option>';
            timelineModel.innerHTML = '<option value="">Select Model</option>';
            
            if (providersData.available_providers) {
                providersData.available_providers.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider;
                    option.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                    timelineProvider.appendChild(option);
                });
            }
        }

        // Update model dropdown when provider changes
        timelineProvider.addEventListener('change', function() {
            timelineModel.innerHTML = '<option value="">Select Model</option>';
            
            const selectedProvider = this.value;
            if (selectedProvider && providersData.provider_models && providersData.provider_models[selectedProvider]) {
                providersData.provider_models[selectedProvider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    timelineModel.appendChild(option);
                });
            }
        });

        // Load writable calendars for timeline
        async function loadWritableCalendars() {
            if (!currentUser || !authToken) return;

            try {
                const response = await fetch('http://localhost:8000/api/v1/calendar/google/calendars/writable', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const calendars = await response.json();
                    console.log('Loaded writable calendars:', calendars);

                    // Clear existing options except primary
                    targetCalendar.innerHTML = '<option value="primary">Primary Calendar</option>';

                    calendars.forEach(calendar => {
                        // Skip primary as it's already added
                        if (calendar.id !== 'primary') {
                            const option = document.createElement('option');
                            option.value = calendar.id;
                            option.textContent = `${calendar.summary} (${calendar.access_role})`;
                            targetCalendar.appendChild(option);
                        }
                    });
                } else {
                    console.warn('Could not load writable calendars');
                }
            } catch (error) {
                console.warn('Error loading writable calendars:', error);
            }
        }


        // Timeline form submission - Preview workflow
        timelineForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            timelineSubmitBtn.disabled = true;
            timelineSubmitBtn.textContent = 'Parsing Timeline...';
            timelineResultDiv.style.display = 'none';
            previewSection.classList.remove('show');

            const formData = new FormData(timelineForm);
            
            const payload = {
                timeline_text: formData.get('timelineText'),
                flexible: formData.get('flexible') === 'on',
                llm_provider: timelineProvider.value || null,
                llm_model: timelineModel.value || null,
                target_calendar_id: targetCalendar.value || 'primary'
            };
            
            console.log('Timeline preview payload:', payload);
            console.log('Selected target calendar:', targetCalendar.value);

            try {
                // Call preview endpoint instead of direct creation
                const response = await fetch('http://localhost:8000/api/v1/timeline/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    // Store preview data for later creation
                    previewData = result;
                    
                    // Show preview section
                    displayPreview(result);
                    previewSection.classList.add('show');
                } else {
                    throw new Error(result.detail || 'Unknown error');
                }
            } catch (error) {
                timelineResultDiv.className = 'result error';
                timelineResultContent.innerHTML = `<strong>Error:</strong> ${error.message}`;
                timelineResultDiv.style.display = 'block';
            }

            timelineSubmitBtn.disabled = false;
            timelineSubmitBtn.textContent = 'Preview Timeline';
        });

        // Display preview data
        function displayPreview(data) {
            // Show preview info
            previewInfo.innerHTML = `
                <strong>Found ${data.total_events} events</strong> | 
                Provider: ${data.used_provider || 'default'} | 
                Model: ${data.used_model || 'default'}
            `;

            // Show preview events
            let eventsHtml = '';
            data.parsed_events.forEach((event, index) => {
                const attendeesList = event.attendees.length > 0 
                    ? `<br><strong>Attendees:</strong> ${event.attendees.join(', ')}`
                    : '';
                
                eventsHtml += `
                    <div class="preview-event">
                        <h4>${index + 1}. ${event.title}</h4>
                        <strong>Date:</strong> ${event.start_date} to ${event.end_date}<br>
                        <strong>Description:</strong> ${event.description}
                        ${attendeesList}
                    </div>
                `;
            });
            previewEvents.innerHTML = eventsHtml;
        }

        // Confirm and create events
        confirmCreateBtn.addEventListener('click', async function() {
            if (!previewData) return;

            confirmCreateBtn.disabled = true;
            confirmCreateBtn.textContent = '⏳ Creating Events...';

            try {
                const response = await fetch('http://localhost:8000/api/v1/timeline/create-events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        events: previewData.parsed_events,
                        target_calendar_id: targetCalendar.value || 'primary'
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Hide preview and show success
                    previewSection.classList.remove('show');
                    timelineResultDiv.className = 'result success';
                    
                    let html = `
                        <strong>✅ Success!</strong><br>
                        <strong>Total Events:</strong> ${result.total_events}<br>
                        <strong>Created Successfully:</strong> ${result.success_count}<br><br>
                        <strong>Created Events:</strong><br>
                    `;
                    
                    result.created_events.forEach((event, index) => {
                        html += `
                            <div style="margin: 10px 0; padding: 10px; background-color: #f0f8f0; border-radius: 3px;">
                                <strong>${index + 1}. ${event.summary}</strong><br>
                                <strong>Date:</strong> ${event.start_date} to ${event.end_date}<br>
                                ${event.html_link ? `<a href="${event.html_link}" target="_blank">🔗 View in Google Calendar</a>` : ''}
                            </div>
                        `;
                    });
                    
                    timelineResultContent.innerHTML = html;
                    timelineResultDiv.style.display = 'block';
                } else {
                    throw new Error(result.detail || 'Unknown error');
                }
            } catch (error) {
                timelineResultDiv.className = 'result error';
                timelineResultContent.innerHTML = `<strong>❌ Error:</strong> ${error.message}`;
                timelineResultDiv.style.display = 'block';
            }

            confirmCreateBtn.disabled = false;
            confirmCreateBtn.textContent = '✅ Confirm & Create Events';
        });

        // Cancel preview
        cancelPreviewBtn.addEventListener('click', function() {
            previewSection.classList.remove('show');
            previewData = null;
        });


        // API Key Management Functions
        async function loadApiKeyStatus() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`http://localhost:8000/api/v1/api-keys/list/${currentUser.user_id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    let statusHtml = '<div style="display: flex; gap: 15px;">';
                    
                    for (const [provider, hasKey] of Object.entries(result.api_keys)) {
                        const status = hasKey ? '✅' : '❌';
                        const color = hasKey ? '#28a745' : '#dc3545';
                        statusHtml += `
                            <div style="padding: 8px 12px; border-radius: 5px; background-color: ${hasKey ? '#d4edda' : '#f8d7da'}; color: ${color};">
                                <strong>${provider.charAt(0).toUpperCase() + provider.slice(1)}:</strong> ${status} ${hasKey ? 'Saved' : 'Not Set'}
                            </div>
                        `;
                    }
                    statusHtml += '</div>';
                    apiKeyStatus.innerHTML = statusHtml;
                } else {
                    apiKeyStatus.innerHTML = '<span style="color: #dc3545;">Failed to load API key status</span>';
                }
            } catch (error) {
                console.error('Failed to load API key status:', error);
                apiKeyStatus.innerHTML = '<span style="color: #dc3545;">Error loading status</span>';
            }
        }

        // Save API Key
        saveApiKeyBtn.addEventListener('click', async function() {
            const provider = apiProvider.value;
            const apiKey = apiKeyInput.value.trim();
            
            if (!provider || !apiKey) {
                alert('Please select a provider and enter an API key');
                return;
            }
            
            if (!currentUser) {
                alert('Please log in first');
                return;
            }
            
            this.disabled = true;
            this.textContent = 'Saving...';
            apiKeyResult.style.display = 'none';
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/api-keys/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        provider: provider,
                        api_key: apiKey,
                        user_id: currentUser.user_id
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    apiKeyResult.className = 'result success';
                    apiKeyResultContent.innerHTML = `✅ ${result.message}`;
                    apiKeyInput.value = ''; // Clear the input
                    await loadApiKeyStatus(); // Refresh status
                } else {
                    throw new Error(result.detail || 'Failed to save API key');
                }
            } catch (error) {
                apiKeyResult.className = 'result error';
                apiKeyResultContent.innerHTML = `❌ Error: ${error.message}`;
            }
            
            apiKeyResult.style.display = 'block';
            this.disabled = false;
            this.textContent = '💾 Save API Key';
        });

        // Test API Key
        testApiKeyBtn.addEventListener('click', async function() {
            const provider = apiProvider.value;
            
            if (!provider) {
                alert('Please select a provider first');
                return;
            }
            
            if (!currentUser) {
                alert('Please log in first');
                return;
            }
            
            this.disabled = true;
            this.textContent = 'Testing...';
            apiKeyResult.style.display = 'none';
            
            try {
                const response = await fetch(`http://localhost:8000/api/v1/api-keys/test/${currentUser.user_id}/${provider}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    apiKeyResult.className = 'result success';
                    apiKeyResultContent.innerHTML = `✅ ${result.message}`;
                } else {
                    apiKeyResult.className = 'result error';
                    apiKeyResultContent.innerHTML = `❌ ${result.message}`;
                }
            } catch (error) {
                apiKeyResult.className = 'result error';
                apiKeyResultContent.innerHTML = `❌ Test failed: ${error.message}`;
            }
            
            apiKeyResult.style.display = 'block';
            this.disabled = false;
            this.textContent = '🔍 Test API Key';
        });

        // Load Calendar List
        async function loadCalendars() {
            if (!currentUser || !authToken) {
                calendarsContainer.innerHTML = '<p style="color: #dc3545;">Please log in to view your calendars.</p>';
                return;
            }

            calendarsContainer.innerHTML = '<p>⏳ Loading calendars...</p>';

            try {
                const response = await fetch('http://localhost:8000/api/v1/calendar/google/calendars', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const calendars = await response.json();
                console.log('Loaded calendars:', calendars);

                if (calendars.length === 0) {
                    calendarsContainer.innerHTML = '<p>No calendars found. Make sure you have granted calendar access.</p>';
                    return;
                }

                let html = '';
                calendars.forEach(calendar => {
                    const colors = ['#4285F4', '#34A853', '#FBBC04', '#EA4335', '#9AA0A6', '#FF6D01', '#46BDC6'];
                    const colorIndex = parseInt(calendar.color_id || '1') - 1;
                    const backgroundColor = colors[colorIndex % colors.length];
                    
                    const badges = [];
                    if (calendar.primary) badges.push('<span class="calendar-badge badge-primary">Primary</span>');
                    if (calendar.access_role === 'owner') badges.push('<span class="calendar-badge badge-owner">Owner</span>');
                    else if (calendar.access_role === 'reader') badges.push('<span class="calendar-badge badge-reader">Reader</span>');

                    html += `
                        <div class="calendar-item">
                            <div class="calendar-icon" style="background-color: ${backgroundColor}">
                                📅
                            </div>
                            <div class="calendar-info">
                                <div class="calendar-name">${calendar.summary}</div>
                                <div class="calendar-details">
                                    ${badges.join(' ')}
                                    <br>
                                    <strong>ID:</strong> ${calendar.id}<br>
                                    ${calendar.description ? `<strong>Description:</strong> ${calendar.description}<br>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                calendarsContainer.innerHTML = html;

            } catch (error) {
                console.error('Failed to load calendars:', error);
                calendarsContainer.innerHTML = `
                    <div style="color: #dc3545; padding: 15px; background-color: #f8d7da; border-radius: 5px;">
                        <strong>❌ Error loading calendars:</strong> ${error.message}
                        <br><small>Make sure you have granted calendar access and your token is valid.</small>
                    </div>
                `;
            }
        }

        // Refresh Calendars Button
        refreshCalendarsBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = '⏳ Loading...';
            
            await loadCalendars();
            
            this.disabled = false;
            this.textContent = '🔄 Refresh Calendar List';
        });

        // Load API key status when switching to API keys tab
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Hide all results when switching tabs
            timelineResultDiv.style.display = 'none';
            previewSection.classList.remove('show');
            
            // Load API key status when switching to API keys tab
            if (tabName === 'apikeys' && currentUser) {
                loadApiKeyStatus();
            }
            
            // Load calendars when switching to calendars tab
            if (tabName === 'calendars' && currentUser) {
                loadCalendars();
            }
        }
    </script>
</body>
</html>